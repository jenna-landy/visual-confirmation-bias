---
title: "vcb_analysis"
format: html
editor: source
---

```{r}
library(dplyr)
library(tidyverse)
library(magrittr)
library(lavaan)
library(broom)
library(pwr)

df_study1 <- read.csv("pilot1_cleaned.csv")
df_study2 <- read.csv("pilot2_cleaned.csv")

df_study2_filtered <- df_study2 %>% dplyr::filter(manipulation_condition_word!="Control")
```

```{r}
#which study are we looking at?
df <- df_study1 #df_study1, df_study2
```

```{r}
report_lm_t <- function(model){
  s  <- summary(model)
  co <- coef(s)
  df <- df.residual(model)
  ci <- confint(model)
  
  terms <- rownames(co)
  terms <- terms[terms != "(Intercept)"]  # drop intercept
  
  out <- sapply(terms, function(term){
    b  <- co[term, "Estimate"]
    se <- co[term, "Std. Error"]
    t  <- co[term, "t value"]
    p  <- co[term, "Pr(>|t|)"]
    ci_l <- ci[term, 1]
    ci_u <- ci[term, 2]
    
    p_txt <- ifelse(p < .001, "p < .001",
                    paste0("p = ", formatC(p, format="f", digits=3)))
    
    sprintf(
      "%s: b = %.2f, 95%% CI [%.2f, %.2f], SE = %.2f, t(%d) = %.2f, %s.",
      term, b, ci_l, ci_u, se, df, t, p_txt
    )
  })
  
  return(out)
}
```

```{r}
report_lavaan_regs <- function(fit){
  pe <- parameterEstimates(fit, ci = TRUE)
  
  # keep only regressions (~)
  pe <- pe[pe$op == "~", ]
  
  out <- apply(pe, 1, function(row){
    
    dv  <- row["lhs"]
    iv  <- row["rhs"]
    b   <- as.numeric(row["est"])
    se  <- as.numeric(row["se"])
    z   <- as.numeric(row["z"])
    p   <- as.numeric(row["pvalue"])
    ci_l <- as.numeric(row["ci.lower"])
    ci_u <- as.numeric(row["ci.upper"])
    
    p_txt <- ifelse(p < .001, "p < .001",
                    paste0("p = ", formatC(p, format="f", digits=3)))
    
    sprintf(
      "%s â†’ %s: b = %.2f, 95%% CI [%.2f, %.2f], SE = %.2f, z = %.2f, %s.",
      iv, dv, b, ci_l, ci_u, se, z, p_txt
    )
  })
  
  return(out)
}
```

```{r}
report_lavaan_defined <- function(fit){
  pe <- parameterEstimates(fit, ci = TRUE)
  
  # keep only defined parameters (:=)
  pe <- pe[pe$op == ":=", ]
  
  out <- apply(pe, 1, function(row){
    
    name <- row["lhs"]          # name of indirect effect
    b    <- as.numeric(row["est"])
    se   <- as.numeric(row["se"])
    z    <- as.numeric(row["z"])
    p    <- as.numeric(row["pvalue"])
    ci_l <- as.numeric(row["ci.lower"])
    ci_u <- as.numeric(row["ci.upper"])
    
    p_txt <- ifelse(p < .001, "p < .001",
                    paste0("p = ", formatC(p, format="f", digits=3)))
    
    sprintf(
      "%s: b = %.2f, 95%% CI [%.2f, %.2f], SE = %.2f, z = %.2f, %s.",
      name, b, ci_l, ci_u, se, z, p_txt
    )
  })
  
  return(out)
}
```

```{r}
print_sem_table <- function(fit, digits = 3) {
  
  pe <- parameterEstimates(fit, ci = TRUE)
  
  # clean + round
  pe <- pe %>%
    mutate(
      est  = round(est, digits),
      se   = round(se, digits),
      z    = round(z, digits),
      p    = round(pvalue, digits),
      ci   = paste0("[",
                    round(ci.lower, digits), ", ",
                    round(ci.upper, digits), "]")
    )
  
  header <- sprintf("%-25s %10s %8s %8s %8s %18s",
                    "", "Estimate", "SE", "z", "p", "95% CI")
  
  line_formatter <- function(name, row) {
    sprintf("%-25s %10.3f %8.3f %8.3f %8.3f %18s",
            name, row$est, row$se, row$z, row$p, row$ci)
  }
  
  ### REGRESSIONS
  cat("\nREGRESSIONS\n")
  cat(header, "\n")
  
  reg <- pe %>% filter(op == "~")
  outcomes <- unique(reg$lhs)
  
  for (y in outcomes) {
    cat("\n", y, "~\n", sep = "")
    sub <- reg %>% filter(lhs == y)
    for (i in 1:nrow(sub)) {
      cat(line_formatter(sub$rhs[i], sub[i, ]), "\n")
    }
  }
  
  ### COVARIANCES
  cat("\n\nCOVARIANCES\n")
  cat(header, "\n")
  
  covs <- pe %>% filter(op == "~~", lhs != rhs)
  for (i in 1:nrow(covs)) {
    name <- paste(covs$lhs[i], "~~", covs$rhs[i])
    cat(line_formatter(name, covs[i, ]), "\n")
  }
  
  ### VARIANCES
  cat("\n\nVARIANCES\n")
  cat(header, "\n")
  
  vars <- pe %>% filter(op == "~~", lhs == rhs)
  for (i in 1:nrow(vars)) {
    name <- paste0(".", vars$lhs[i])
    cat(line_formatter(name, vars[i, ]), "\n")
  }
  
  ### DEFINED PARAMETERS
  cat("\n\nDEFINED PARAMETERS\n")
  cat(header, "\n")
  
  defs <- pe %>% filter(op == ":=")
  for (i in 1:nrow(defs)) {
    cat(line_formatter(defs$lhs[i], defs[i, ]), "\n")
  }
}
```

ANALYSES

```{r}
#path c: total effect (don't report this directly - just a quick decontextualized way to isolate the path)
model_total <- lm(post_evidence_guilt_belief ~ 
                    manipulation_condition + #predictor
                    system_justification_GMC + #predictor
                    right_wing_authoritarianism_GMC + #control for covar
                    #need_for_cognition_GMC + #control for covar #comment out for df_study2
                    social_dominance_orientation_GMC + #control for covar
                    political_orientation #control for covar
                    , df)

summary(model_total)
confint(model_total)
df.residual(model_total)
```

```{r}
#path b2 (don't report this directly - just a quick decontextualized way to isolate the path)
model <- lm(post_evidence_guilt_belief ~ 
              alignment_search + #predictor
              pre_evidence_guilt_belief + #control for m1
              system_justification_GMC + manipulation_condition + #control for x1 and x2
              right_wing_authoritarianism_GMC + #control for covar
              #need_for_cognition_GMC + #control for covar #comment out for df_study2
              social_dominance_orientation_GMC + #control for covar
              political_orientation #control for covar
              , df)

summary(model)
confint(model)
df.residual(model)

ggplot(df, 
       aes(x = alignment_search, y = post_evidence_guilt_belief)) +
  geom_point() + 
  geom_smooth(method = "lm")
```

```{r}
#path b1 (don't report this directly - just a quick decontextualized way to isolate the path)
model <- lm(alignment_search ~ 
              pre_evidence_guilt_belief + #predictor
              system_justification_GMC + manipulation_condition + #control for x1 and x2
              right_wing_authoritarianism_GMC + #control for covar
              #need_for_cognition_GMC + #control for covar #comment out for df_study2
              social_dominance_orientation_GMC + #control for covar
              political_orientation #control for covar
              , df)

summary(model)
confint(model)
df.residual(model)

ggplot(df, 
       aes(x = pre_evidence_guilt_belief, y = alignment_search)) +
  geom_point() + 
  geom_smooth(method = "lm")
```

```{r}
#path a (don't report this directly except aic/bic - just a quick decontextualized way to isolate the path)
model1 <- lm(pre_evidence_guilt_belief ~
             manipulation_condition + #predictor
             system_justification_GMC + #predictor 
             right_wing_authoritarianism_GMC + #control for covar
             #need_for_cognition_GMC + #control for covar #comment out for df_study2
             social_dominance_orientation_GMC + #control for covar
             political_orientation #control for covar
             , df)

summary(model1)
confint(model1)
df.residual(model1)

ggplot(df, 
       aes(x = system_justification_GMC, y = pre_evidence_guilt_belief, color = manipulation_condition_word)) +
  geom_point() + 
  geom_smooth(method = "lm")
```

```{r}
#plot for manuscript: pilot study 1

df$system_justification_uncentered = df$system_justification_GMC + 3.875988 #number used when we centered SJ
  
ggplot(
  df,
  aes(
    x = system_justification_uncentered,
    y = pre_evidence_guilt_belief,
    fill = manipulation_condition_word
  )
) +
  geom_jitter(
    height = .1,
    shape = 21,
    size = 3,
    color = "black",
    alpha = .9
  ) +
  geom_smooth(
    aes(linetype = manipulation_condition_word),
    method = "lm",
    color = "black",
    size = 1, #change to 2 for thicker lines
    se = FALSE
  ) +
  scale_fill_manual(
    values = c("grey20", "grey70")
  ) +
  theme_bw()
```

```{r}
#plot for manuscript: pilot study 2

df$system_justification_uncentered = df$system_justification_GMC + 4.894096 #number used when we centered SJ

ggplot(
  df,
  aes(
    x = system_justification_uncentered,
    y = pre_evidence_guilt_belief,
    fill = manipulation_condition_word
  )
) +
  geom_jitter(
    height = .1,
    shape = 21,
    size = 3,
    color = "black",
    alpha = .9
  ) +
  geom_smooth(
    aes(linetype = manipulation_condition_word),
    method = "lm",
    color = "black",
    size = 1, #change to 2 for thicker lines
    se = FALSE
  ) +
  scale_fill_manual(
    values = c("white", "grey60", "grey20")
  ) +
  scale_linetype_manual(
    values = c("dotted", "dashed", "solid")
  ) +
  theme_bw()
```

```{r}
model2 <- lm(pre_evidence_guilt_belief ~ #manipulation interacts with sj
             manipulation_condition * system_justification_GMC + #predictors
             right_wing_authoritarianism_GMC + #control for covar
             #need_for_cognition_GMC + #control for covar #comment out for df_study2
             social_dominance_orientation_GMC + #control for covar
             political_orientation, #control for covar
           df)

summary(model2)
confint(model2)
df.residual(model2)

model3 <- lm(pre_evidence_guilt_belief ~ #manipulation interacts with everything
             manipulation_condition * #predictor
             (system_justification_GMC + #predictor
             right_wing_authoritarianism_GMC + #control for covar
             #need_for_cognition_GMC + #control for covar #comment out for df_study2
             social_dominance_orientation_GMC) + #control for covar
             political_orientation, #control for covar
           df)

summary(model3)
confint(model3)
df.residual(model3)

#model4 <- lm(pre_evidence_guilt_belief ~ manipulation_condition + system_justification_GMC, df) #no covar

AIC(model1, model2, model3)
BIC(model1, model2, model3)
```

```{r}
#model1 breakdown for study 2
df$manipulation_condition_f <- as.factor(df$manipulation_condition)
df$manipulation_condition_f <- relevel(df$manipulation_condition_f, ref = "-0.5") # "-0.5" ; "0" ; "0.5"

model1 <- lm(pre_evidence_guilt_belief ~
             manipulation_condition_f + #predictor AS FACTOR
             system_justification_GMC + #predictor 
             right_wing_authoritarianism_GMC + #control for covar
             #need_for_cognition_GMC + #control for covar #always commented out - only for df_study2
             social_dominance_orientation_GMC + #control for covar
             political_orientation, #control for covar
           df)

summary(model1)
confint(model1)
df.residual(model1)
report_lm_t(model1)

```

```{r}
#full model: study 1
set.seed(18936)

#X1: manipulation_condition
#X2: system_justification_GMC

#M1: pre_evidence_guilt_belief

#M2: alignment_search

#Y1: post_evidence_similarity
#Y2: post_evidence_match (STUDY 1 ONLY)
#Y3: post_evidence_guilt_belief (STUDY 1 ONLY)

#covar1: right_wing_authoritarianism_GMC
#covar2: social_dominance_orientation_GMC
#covar3: political_orientation
#covar4: need_for_cognition_GMC (STUDY 1 ONLY)

model <- '
  # --- Regressions ---
  pre_evidence_guilt_belief ~ a1*manipulation_condition + a2*system_justification_GMC +
                              right_wing_authoritarianism_GMC + social_dominance_orientation_GMC +
                              political_orientation + need_for_cognition_GMC

  alignment_search ~  b*pre_evidence_guilt_belief +
                              manipulation_condition + system_justification_GMC +
                              right_wing_authoritarianism_GMC + social_dominance_orientation_GMC +
                              political_orientation + need_for_cognition_GMC

  post_evidence_similarity ~ c1*alignment_search +
                              pre_evidence_guilt_belief +
                              d1*manipulation_condition + d2*system_justification_GMC +
                              right_wing_authoritarianism_GMC + social_dominance_orientation_GMC +
                              political_orientation + need_for_cognition_GMC

  post_evidence_match ~ c2*alignment_search + 
                              pre_evidence_guilt_belief +
                              d3*manipulation_condition + d4*system_justification_GMC +
                              right_wing_authoritarianism_GMC + social_dominance_orientation_GMC +
                              political_orientation + need_for_cognition_GMC

  post_evidence_guilt_belief ~ c3*alignment_search + 
                              pre_evidence_guilt_belief +
                              d5*manipulation_condition + d6*system_justification_GMC +
                              right_wing_authoritarianism_GMC + social_dominance_orientation_GMC +
                              political_orientation + need_for_cognition_GMC

  # --- Covariate correlations ---
  system_justification_GMC ~~ right_wing_authoritarianism_GMC + 
                              social_dominance_orientation_GMC +
                              political_orientation + 
                              need_for_cognition_GMC
  right_wing_authoritarianism_GMC ~~ social_dominance_orientation_GMC + 
                                     political_orientation +
                                     need_for_cognition_GMC
  social_dominance_orientation_GMC ~~ political_orientation + 
                                      need_for_cognition_GMC
  political_orientation ~~ need_for_cognition_GMC

  # --- Indirect effects ---
  ind_X1_Y1 := a1 * b * c1
  ind_X1_Y2 := a1 * b * c2
  ind_X1_Y3 := a1 * b * c3
  
  ind_X2_Y1 := a2 * b * c1
  ind_X2_Y2 := a2 * b * c2
  ind_X2_Y3 := a2 * b * c3
  
  # --- Direct effects ---
  dir_X1_Y1 := d1
  dir_X2_Y1 := d2
  
  dir_X1_Y2 := d3
  dir_X2_Y2 := d4
  
  dir_X1_Y3 := d5
  dir_X2_Y3 := d6
  
  # --- Total effects ---
  total_X1_Y1 := d1 + (a1 * b * c1)
  total_X2_Y1 := d2 + (a2 * b * c1)
  
  total_X1_Y2 := d3 + (a1 * b * c2)
  total_X2_Y2 := d4 + (a2 * b * c2)
  
  total_X1_Y3 := d5 + (a1 * b * c3)
  total_X2_Y3 := d6 + (a2 * b * c3)
'


```

```{r}
#full model: study 2
set.seed(63440)

#X1: manipulation_condition
#X2: system_justification_GMC

#M1: pre_evidence_guilt_belief

#M2: alignment_search

#Y1: post_evidence_similarity

#covar1: right_wing_authoritarianism_GMC
#covar2: social_dominance_orientation_GMC
#covar3: political_orientation

df$manipulation_condition_f <- relevel(df$manipulation_condition_f, ref = "0")

model <- '
  # --- Regressions ---
  pre_evidence_guilt_belief ~ a1*manipulation_condition + a2*system_justification_GMC +
                              right_wing_authoritarianism_GMC + 
                              social_dominance_orientation_GMC +
                              political_orientation

  alignment_search ~ b*pre_evidence_guilt_belief +
                     manipulation_condition + system_justification_GMC +
                     right_wing_authoritarianism_GMC + 
                     social_dominance_orientation_GMC +
                     political_orientation

  post_evidence_guilt_belief ~ c*alignment_search +
                                pre_evidence_guilt_belief +
                                d1*manipulation_condition + d2*system_justification_GMC +
                                right_wing_authoritarianism_GMC + 
                                social_dominance_orientation_GMC +
                                political_orientation

  # --- Covariate correlations ---
  system_justification_GMC ~~ right_wing_authoritarianism_GMC + 
                              social_dominance_orientation_GMC +
                              political_orientation
  right_wing_authoritarianism_GMC ~~ social_dominance_orientation_GMC + 
                                     political_orientation
  social_dominance_orientation_GMC ~~ political_orientation

  # --- Indirect effects ---
  ind_X1_Y := a1 * b * c
  ind_X2_Y := a2 * b * c
  
  # --- Direct effects ---
  dir_X1_Y := d1
  dir_X2_Y := d2
  
  # --- Total effects ---
  total_X1_Y := d1 + (a1 * b * c)
  total_X2_Y := d2 + (a2 * b * c)
'

```

```{r}
fit <- sem(model, data = df, se = "bootstrap", bootstrap = 10000)
summary(fit, standardized = TRUE, rsquare = TRUE, ci = TRUE) #ci = TRUE if you want confidence intervals
report_lavaan_regs(fit)
report_lavaan_defined(fit)
print_sem_table(fit)
```

```{r}
#study 1: PROCESS
process(data = df_study1,
        y = "post_evidence_guilt_belief", 
        #"post_evidence_similarity" ; "post_evidence_match" ; "post_evidence_guilt_belief"
        x = "system_justification_GMC",
        m = c("pre_evidence_guilt_belief", "alignment_search"),
        cov = c("manipulation_condition",
                "right_wing_authoritarianism_GMC",
                "social_dominance_orientation_GMC",
                "need_for_cognition_GMC",
                "political_orientation"),
        boot = 10000,
        model = 6)
```

```{r}
#study 2: PROCESS
process(data = df_study2,
        y = "post_evidence_guilt_belief",
        x = "system_justification_GMC",
        m = c("pre_evidence_guilt_belief", "alignment_search"),
        cov = c("manipulation_condition",
                "right_wing_authoritarianism_GMC",
                "social_dominance_orientation_GMC",
                "political_orientation"),
        boot = 10000,
        model = 6)
```

STUDY 3: Power simulations using Study 2 results

```{r}
df <- df_study2

#main effect of interest
ggplot(df, aes(x = alignment_search, y = post_evidence_guilt_belief)) +
  geom_point(alpha = 0.5) +  
  geom_smooth(method = "lm", se = TRUE, alpha = 0.1)

summary(lm(post_evidence_guilt_belief ~ alignment_search, df)) #numbers don't change TOO much with added covariates

beta1 <- coef(lm(post_evidence_guilt_belief ~ alignment_search, df))[2]
beta0 <- coef(lm(post_evidence_guilt_belief ~ alignment_search, df))[1]
residual_se <- summary(lm(post_evidence_guilt_belief ~ alignment_search, df))$sigma


#FORMULA: y = mx+b + error
#y: post_evidence_guilt_belief
#x: alignment_search
#beta1 (slope): 0.942 (m)
#beta0 (intercept): -0.070 (b)
#residual standard error: 1.250
```


```{r}
#start by making a reasonable distribution for your predictor (alignment_search) -- feed this into x
#now treated as experimentally manipulated

simulated_data <- data.frame(
  alignment_search = runif(n = 100, min = -2, max = 2)
)

#now calculate y
simulated_data <- simulated_data |> 
  dplyr::mutate(
    post_evidence_guilt_belief = 
      0.942 * alignment_search + 
      rnorm(n = 100, mean = 0, sd = 1.250)
  ) |>
  dplyr::mutate(
    post_evidence_guilt_belief = 
      pmax(pmin(post_evidence_guilt_belief, 3), -3)
  )

#plot and run lm to see what your simulated data looks like
ggplot(simulated_data, aes(x = alignment_search, y = post_evidence_guilt_belief)) +
  geom_point(alpha = 0.5) +  
  geom_smooth(method = "lm", se = TRUE, alpha = 0.1)

summary(lm(post_evidence_guilt_belief ~ alignment_search, simulated_data))
```

```{r}
#doing the same thing again but making a function this time
simulate_dataset <- function(x_mean, x_sd, n, beta1, beta0, residual_se){
  
  simulated_data <- data.frame(
    x = runif(n = n, min = -2, max = 2)
    )
  
  simulated_data <- simulated_data |> 
    dplyr::mutate(
      y = beta1 * x + rnorm(n = n, mean = 0, sd = residual_se)
      ) |>
    dplyr::mutate(
      y = pmax(pmin(y, 3), -3)
    )
  
  return(simulated_data)

}
```

```{r}
#running the function with nearly no hard-coding (except n)
simulated_data <- simulate_dataset(mean(df$alignment_search), 
                 sd(df$alignment_search), 
                 100, 
                 coef(lm(post_evidence_guilt_belief ~ alignment_search, df))[2],
                 coef(lm(post_evidence_guilt_belief ~ alignment_search, df))[1],
                 summary(lm(post_evidence_guilt_belief ~ alignment_search, df))$sigma)

#plot and run lm to see what your simulated data looks like
ggplot(simulated_data, aes(x = x, y = y)) +
  geom_point(alpha = 0.5) +  
  geom_smooth(method = "lm", se = TRUE, alpha = 0.1)

summary(lm(y ~ x, simulated_data))
```


```{r}
#loop over simulate_dataset() for many simulations

simulate_power <- function(n_sims, x_mean, x_sd, n, beta1, beta0, residual_se){
  
  #create a df to hold sim results
  coef_power <- data.frame(
    sig_betaO = rep(NA, n_sims),
    sig_beta1 = rep(NA, n_sims) #this is the important value
  )
  
  #loop many sims and fill df
  for(dataset_i in 1:n_sims){
    simulated_data <- simulate_dataset(x_mean, x_sd, n, beta1, beta0, residual_se)
    
    model <- tidy(lm(y~x, data=simulated_data))
    
    coef_power$sig_betaO[dataset_i] <- model$p.value[1] < .05 #b
    coef_power$sig_beta1[dataset_i] <- model$p.value[2] < .05 #m
  }
  
  #aggregate
  coef_power <- summarize(coef_power,
                          beta0_power = mean(sig_betaO),
                          beta1_power = mean(sig_beta1)
                          )
  
  return(coef_power)
  
}
```

```{r}
#running the function with nearly no hard-coding (except n_sims and n)
beta_planned <- (coef(lm(post_evidence_guilt_belief ~ alignment_search, df))[2]) * .25 #assume slope 1/4 as angular

simulated_power <- simulate_power(1000,
                                  mean(df$alignment_search),
                                  sd(df$alignment_search),
                                  275, #turn up sample size to watch power go up
                                  beta_planned,
                                  coef(lm(post_evidence_guilt_belief ~ alignment_search, df))[1],
                                  summary(lm(post_evidence_guilt_belief ~ alignment_search, df))$sigma)

simulated_power
#beta1 (m) power is more interesting to us: power for the slope
```

```{r}
cor.test(df$alignment_search, df$post_evidence_guilt_belief) #.67

pwr.r.test(
  n = NULL,
  r = .67/4,
  sig.level = 0.05,
  power = 0.8,
  alternative = "two.sided"
)
```


